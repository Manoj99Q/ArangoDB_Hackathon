
                    <html lang="en">
                    <head>
                    <meta charset="UTF-8">
                    <script src="https://d3js.org/d3.v6.min.js"></script>
                    <style>
                        body { 
                            font: 14px sans-serif; 
                            margin: 0; 
                            padding: 0;
                            width: 100vw;
                            height: 100vh;
                            background-color: white;
                            overflow: hidden;
                        }
                        
                        #visualization-container {
                            width: 100vw;
                            height: 100vh;
                            position: relative;
                            overflow: hidden;
                        }  
                        
                        svg {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            display: block;
                        }
                    </style>
                    </head>
                    <body>
                    <div id="visualization-container">
                        <svg></svg>
                    </div>
        
                    <script>
                        // Data from the application state
                        const data = {"hardcore_gamers": [{"user": {"_key": "126340495", "_id": "Users/126340495", "_rev": "_jT6zKqy--O", "type": "Users", "steamid": 126340495}, "games_over_200_count": 2}, {"user": {"_key": "11373749", "_id": "Users/11373749", "_rev": "_jT6zKqy--u", "type": "Users", "steamid": 11373749}, "games_over_200_count": 4}, {"user": {"_key": "54103616", "_id": "Users/54103616", "_rev": "_jT6zKqy--y", "type": "Users", "steamid": 54103616}, "games_over_200_count": 2}, {"user": {"_key": "163617342", "_id": "Users/163617342", "_rev": "_jT6zKqy--7", "type": "Users", "steamid": 163617342}, "games_over_200_count": 2}, {"user": {"_key": "171847029", "_id": "Users/171847029", "_rev": "_jT6zKqy-_V", "type": "Users", "steamid": 171847029}, "games_over_200_count": 2}, {"user": {"_key": "46759859", "_id": "Users/46759859", "_rev": "_jT6zKq2--M", "type": "Users", "steamid": 46759859}, "games_over_200_count": 2}, {"user": {"_key": "94088853", "_id": "Users/94088853", "_rev": "_jT6zKq2--z", "type": "Users", "steamid": 94088853}, "games_over_200_count": 2}, {"user": {"_key": "148510973", "_id": "Users/148510973", "_rev": "_jT6zKq2-_-", "type": "Users", "steamid": 148510973}, "games_over_200_count": 2}, {"user": {"_key": "9823354", "_id": "Users/9823354", "_rev": "_jT6zKq2-_F", "type": "Users", "steamid": 9823354}, "games_over_200_count": 2}, {"user": {"_key": "95898619", "_id": "Users/95898619", "_rev": "_jT6zKq2-_V", "type": "Users", "steamid": 95898619}, "games_over_200_count": 2}]};
        
                        // Function to get dimensions with margins
                         function getDimensions() {
                            const container = document.getElementById('visualization-container');
                            const fullWidth = container.clientWidth;
                            const fullHeight = container.clientHeight;
                            
                            const margin = {top: 20, right: 20, bottom: 20, left: 20};
                            const width = fullWidth - margin.left - margin.right;
                            const height = fullHeight - margin.top - margin.bottom;
                            
                            return { width, height, margin, fullWidth, fullHeight };
                        }
                        // Get SVG dimensions
                        const svg = d3.select("svg")
                            .attr("preserveAspectRatio", "xMidYMid meet")
                            .attr("viewBox", function() {
                                const dims = getDimensions();
                                return `0 0 ${dims.fullWidth} ${dims.fullHeight}`;
                            });
                        
                        // Get initial dimensions for setup
                        const initialDimensions = getDimensions();
                        
                        // Create main group
                        const g = svg.append("g")
                            .attr("transform", `translate(${initialDimensions.margin.left},${initialDimensions.margin.top})`);

                        // Update zoom behavior to use dynamic dimensions
                        const zoom = d3.zoom()
                            .scaleExtent([0.1, 4])
                            .on("zoom", (event) => {
                                g.attr("transform", event.transform);
                            });

                        svg.call(zoom);
                        
                        // IMPORTANT: DO NOT use width or height as global variables!
                        // ALWAYS call getDimensions() to get the current dimensions when needed.
                        // Example: const { width, height } = getDimensions();
                    </script>
        
<script>
    // 1. Process data and declare data-derived variables
    const processedData = (data?.hardcore_gamers || [])
        .filter(item => item && item.user && item.games_over_200_count)
        .map(item => ({
            steamId: item.user.steamid || 'Unknown',
            count: item.games_over_200_count || 0
        }));

    // 2. Define scales and utility functions
    const { width, height } = getDimensions();
    const radius = Math.min(width, height) / 2 * 0.8;

    const color = d3.scaleOrdinal()
        .domain(processedData.map(d => d.steamId))
        .range(d3.schemeCategory10);

    const pie = d3.pie()
        .value(d => d.count)
        .sort(null);

    const arc = d3.arc()
        .innerRadius(0)
        .outerRadius(radius);

    const labelArc = d3.arc()
        .innerRadius(radius * 0.6)
        .outerRadius(radius * 0.6);

    // 3. Initialize variables for center translation
    const centerX = width / 2;
    const centerY = height / 2;

    // 4. Create tooltip
    const tooltip = d3.select("#visualization-container")
        .append("div")
        .style("position", "absolute")
        .style("visibility", "hidden")
        .style("background-color", "rgba(255, 255, 255, 0.9)")
        .style("padding", "8px")
        .style("border-radius", "4px")
        .style("border", "1px solid #ddd");

    // 5. Define event handlers
    const mouseOver = (event, d) => {
        tooltip.style("visibility", "visible")
            .html(`Steam ID: ${d.data.steamId}<br>Games over 200hrs: ${d.data.count}`);
    };

    const mouseMove = (event) => {
        tooltip.style("top", (event.pageY - 10) + "px")
            .style("left", (event.pageX + 10) + "px");
    };

    const mouseLeave = () => {
        tooltip.style("visibility", "hidden");
    };

    // 6. Create and append visual elements
    // Move the pie chart to the center
    const pieG = g.append("g")
        .attr("transform", `translate(${centerX},${centerY})`);

    // Create pie segments
    const paths = pieG.selectAll("path")
        .data(pie(processedData))
        .enter()
        .append("path")
        .attr("d", arc)
        .attr("fill", d => color(d.data.steamId))
        .attr("stroke", "white")
        .style("stroke-width", "2px")
        .style("opacity", 0.8)
        .on("mouseover", mouseOver)
        .on("mousemove", mouseMove)
        .on("mouseleave", mouseLeave)
        .transition()
        .duration(1000)
        .attrTween("d", function(d) {
            const interpolate = d3.interpolate({startAngle: 0, endAngle: 0}, d);
            return function(t) {
                return arc(interpolate(t));
            };
        });

    // Add labels
    const labels = pieG.selectAll("text")
        .data(pie(processedData))
        .enter()
        .append("text")
        .attr("transform", d => `translate(${labelArc.centroid(d)})`)
        .attr("dy", "0.35em")
        .style("text-anchor", "middle")
        .style("font-size", "12px")
        .style("fill", "#333")
        .style("opacity", 0)
        .text(d => `${d.data.count}`)
        .transition()
        .delay(1000)
        .duration(500)
        .style("opacity", 1);

    // Add resize handler
    window.addEventListener('resize', () => {
        const { width: newWidth, height: newHeight } = getDimensions();
        const newRadius = Math.min(newWidth, newHeight) / 2 * 0.8;
        
        arc.outerRadius(newRadius);
        labelArc.innerRadius(newRadius * 0.6).outerRadius(newRadius * 0.6);
        
        pieG.attr("transform", `translate(${newWidth/2},${newHeight/2})`);
        
        paths.attr("d", arc);
        labels.attr("transform", d => `translate(${labelArc.centroid(d)})`);
    });
</script>

        </body>
        </html>