<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D3.js Visualization</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body { font: 14px sans-serif; margin: 0; padding: 0; }
    #visualization-container { width: 100%; height: 100%; }
    svg {width: 100%; height: 600px; border: 1px solid #ccc; }

  </style>
  <script>
    // Data from the application state
    const data = [{"most_influential_game": [{"game": {"_key": "11371_dota_2", "_id": "Games/11371_dota_2", "_rev": "_jPaYcPq--B", "type": "Games", "GameName": "Dota 2"}, "userCount": 4841}]}, {"top_5_users": []}];
  </script>
</head>
<body>
  <h2 id="visualization-title">Data Visualization</h2>
  <div id="visualization-container">
    <svg></svg>
  </div>
<script>
  // Add visualization-specific CSS
  const style = document.createElement('style');
  style.textContent = `
    .game-node {
      fill: #4a90e2;
      stroke: #2171c7;
      stroke-width: 2px;
    }
    .user-node {
      fill: #e2844a;
      stroke: #c75721;
      stroke-width: 2px;
    }
    .node-label {
      font-family: Arial, sans-serif;
      font-size: 12px;
      text-anchor: middle;
    }
    .connection-line {
      stroke: #999;
      stroke-opacity: 0.6;
      stroke-width: 1px;
      stroke-dasharray: 3,3;
    }
  `;
  document.head.appendChild(style);

  // Select SVG and get dimensions
  const svg = d3.select("svg");
  const width = +svg.attr("width");
  const height = +svg.attr("height");

  // Create container group with zoom capability
  const g = svg.append("g");
  svg.call(d3.zoom()
    .extent([[0, 0], [width, height]])
    .scaleExtent([0.5, 5])
    .on("zoom", (event) => g.attr("transform", event.transform)));

  // Extract game data
  const gameData = data[0].most_influential_game[0];
  const gameName = gameData.game.GameName;
  const userCount = gameData.userCount;

  // Create nodes data structure
  const nodes = [
    { id: "game", label: `${gameName}\n(${userCount} users)`, type: "game" },
    { id: "user1", label: "User Placeholder 1", type: "user" },
    { id: "user2", label: "User Placeholder 2", type: "user" },
    { id: "user3", label: "User Placeholder 3", type: "user" },
    { id: "user4", label: "User Placeholder 4", type: "user" },
    { id: "user5", label: "User Placeholder 5", type: "user" }
  ];

  // Create links data structure
  const links = nodes.slice(1).map(node => ({
    source: "game",
    target: node.id
  }));

  // Create force simulation
  const simulation = d3.forceSimulation(nodes)
    .force("link", d3.forceLink(links).id(d => d.id).distance(100))
    .force("charge", d3.forceManyBody().strength(-500))
    .force("center", d3.forceCenter(width / 2, height / 2));

  // Draw links
  const link = g.append("g")
    .selectAll("line")
    .data(links)
    .join("line")
    .attr("class", "connection-line");

  // Draw nodes
  const node = g.append("g")
    .selectAll("circle")
    .data(nodes)
    .join("circle")
    .attr("class", d => d.type === "game" ? "game-node" : "user-node")
    .attr("r", d => d.type === "game" ? 40 : 20)
    .call(d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended));

  // Add labels
  const label = g.append("g")
    .selectAll("text")
    .data(nodes)
    .join("text")
    .attr("class", "node-label")
    .attr("dy", ".35em")
    .text(d => d.label)
    .each(function(d) {
      if (d.type === "game") {
        const lines = d.label.split('\n');
        d3.select(this).selectAll('tspan')
          .data(lines)
          .join('tspan')
          .attr('x', 0)
          .attr('dy', (_, i) => i === 0 ? 0 : '1.2em')
          .text(line => line);
      }
    });

  // Update positions on simulation tick
  simulation.on("tick", () => {
    link
      .attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y);

    node
      .attr("cx", d => d.x)
      .attr("cy", d => d.y);

    label
      .attr("x", d => d.x)
      .attr("y", d => d.y);
  });

  // Drag functions
  function dragstarted(event, d) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(event, d) {
    d.fx = event.x;
    d.fy = event.y;
  }

  function dragended(event, d) {
    if (!event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
</script>
</body>
</html>